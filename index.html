<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>NIR8 Calculators</title>
    <meta name="color-scheme" content="light only">

    <!-- MathJax -->
    <script>
        MathJax = {
            loader: { load: ['input/tex', 'output/chtml'] },
            tex: {
                inlineMath: [['\( ', ' \)'], ['\\(', '\\)']],
                packages: {'[+]': ['base', 'ams']},
                processEscapes: true
            },
            chtml: { scale: 0.9, mtextInheritFont: true },
            startup: {
                typeset: false,
                pageReady() {
                    MathJax.startup.defaultPageReady();
                    document.dispatchEvent(new Event('MathJaxReady'));
                }
            }
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>

    <!-- Styles -->
    <style>
        :root {
            --primary: #28a745;
            --primary-dark: #218838;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #333;
            min-height: 100vh;
            padding-top: 90px;
        }

        /* ── Full-screen overlay ─────────────────────────────────────────────── */
        #qtyOverlay {
            position: fixed;
            inset: 0;
            background: rgba(20, 30, 50, 0.92);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.7s ease;
        }

        #qtyOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .overlay-content {
            background: white;
            padding: 3.5rem 4rem;
            border-radius: 16px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.45);
            text-align: center;
            max-width: 520px;
            width: 90%;
            transform: scale(0.92);
            opacity: 0;
            animation: popupAppear 0.6s 0.2s forwards cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popupAppear {
            to { transform: scale(1); opacity: 1; }
        }

        .overlay-content h2 {
            margin-bottom: 1.6rem;
            font-size: 1.8rem;
            color: var(--dark);
            font-weight: 600;
        }

        #stdQtyOverlay {
            width: 260px;
            font-size: 2.4rem;
            font-weight: 500;
            padding: 0.9rem 1.2rem;
            text-align: center;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            transition: all 0.25s;
        }

        #stdQtyOverlay:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(40,167,69,0.18);
            outline: none;
        }

        #qtyWarning {
            margin-top: 1rem;
            color: var(--danger);
            font-size: 1.05rem;
            min-height: 1.4em;
        }

        /* ── Curtain lift animation ──────────────────────────────────────────── */
        #qtyOverlay.curtain-lift {
            animation: curtainLift 900ms cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes curtainLift {
            0%   { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }

        /* ── Menu Bar ────────────────────────────────────────────────────────── */
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(20, 30, 50, 0.92);
            backdrop-filter: blur(10px);
            color: white;
            z-index: 999;
            padding: 0.9rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .menu-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.8rem;
            flex-wrap: wrap;
        }

        .menu-item {
            padding: 0.6rem 1.3rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.25s;
        }

        .menu-item:hover { background: rgba(255,255,255,0.12); }
        .menu-item.active { background: var(--primary); }

        .menu-qty-tracker {
            display: flex;
            align-items: center;
            gap: 1.6rem;
            margin-left: auto;
        }

        .menu-qty-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .menu-qty-label {
            font-size: 0.78rem;
            color: #adb5bd;
            margin-bottom: 0.35rem;
        }

        .menu-qty-input,
        .lot-select {
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            border: 1px solid #495057;
            background: white;
            color: #212529;
            font-size: 1rem;
            width: 120px;
            text-align: center;
        }

        .menu-qty-value {
            font-size: 1.15rem;
            font-weight: 600;
        }

        .menu-qty-warning {
            color: #ff6b6b;
            font-size: 0.75rem;
            margin-top: 0.3rem;
            background: rgba(220,53,69,0.15);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            display: none;
        }

        .menu-qty-warning.active { display: inline-block; }

        /* ── Main content ────────────────────────────────────────────────────── */
        .calculator-container {
            background: white;
            margin: 2rem auto;
            padding: 2.5rem;
            width: 90%;
            max-width: 960px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        /* Add-lot button */
        .add-lot-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            font-size: 1.4rem;
            line-height: 1;
            cursor: pointer;
            margin-left: 12px;
            vertical-align: middle;
            transition: background 0.2s;
        }

        .add-lot-btn:hover { background: var(--primary-dark); }

        /* Your existing table, calculation entry, print styles etc. go here */
        /* ↓ Paste your original detailed styles for tables, entries, print media etc. below this line ↓ */

        /* Example minimal table style – replace/extend with your full version */
        .acb-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
        }
        .acb-th, .acb-td {
            border: 1px solid #dee2e6;
            padding: 0.9rem;
            text-align: center;
        }
        .acb-th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        .acb-input {
            width: 100%;
            padding: 0.55rem;
            font-size: 1rem;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 6px;
        }
        .acb-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(40,167,69,0.15);
        }
    </style>
</head>
<body>

<!-- Full-screen initial overlay -->
<div id="qtyOverlay">
    <div class="overlay-content">
        <h2>Theoretical Std. Qty <small>(per lot)</small></h2>
        <input type="number" id="stdQtyOverlay" step="0.001" min="0.001" placeholder="500.000" autofocus>
        <div id="qtyWarning"></div>
    </div>
</div>

<!-- Menu Bar -->
<div class="menu-bar">
    <div class="menu-container">
        <div class="menu-item active" id="menuFormula" onclick="showCalculator('formula')">Formula Calculator</div>
        <div class="menu-item" id="menuAcb" onclick="showCalculator('acb')">(A+C)-B Calculator</div>

        <div class="menu-qty-tracker">
            <div class="menu-qty-group">
                <label class="menu-qty-label">Std Qty (kg) per lot</label>
                <input type="number" id="stdQty" class="menu-qty-input" step="0.001" placeholder="Enter qty">
            </div>
            <div class="menu-qty-group">
                <label class="menu-qty-label">Dispensed</label>
                <div id="dispensedQty" class="menu-qty-value">0.000</div>
            </div>
            <div class="menu-qty-group">
                <label class="menu-qty-label">Remaining</label>
                <div id="remainingQty" class="menu-qty-value">-</div>
                <div id="quantityWarning" class="menu-qty-warning">Qty mismatch!</div>
            </div>
            <div class="menu-qty-group" id="lotSelectGroup" style="display:none;">
                <label class="menu-qty-label">Assign to Lot</label>
                <select id="lotSelect" class="lot-select">
                    <option value="" disabled selected>Select</option>
                    <option value="1">I</option>
                    <option value="2">II</option>
                    <option value="3">III</option>
                    <option value="4">IV</option>
                    <option value="5">V</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Your existing calculator containers, calculation steps etc. go here -->
<!-- ↓ Paste your original HTML structure for formula calculator, (A+C)-B table, results etc. ↓ -->

<!-- Example placeholder – replace with your full content -->
<div id="formulaCalculator" class="calculator-container active">
    <h2>Formula Calculator</h2>
    <p>(Your original formula calculator fields and buttons here)</p>
</div>

<div id="acbCalculator" class="calculator-container">
    <h2>(A+C)-B Calculator</h2>
    <!-- Your dynamic table will be built here -->
</div>

<!-- JavaScript -->
<script>
    const LOT_ROMAN = ['I','II','III','IV','V'];
    let visibleLots = 1;

    // DOM elements
    const overlay = document.getElementById('qtyOverlay');
    const overlayInput = document.getElementById('stdQtyOverlay');
    const qtyWarning = document.getElementById('qtyWarning');
    const stdQtyInput = document.getElementById('stdQty');

    // Curtain + hide overlay
    function hideOverlayWithCurtain() {
        overlay.classList.add('curtain-lift');
        setTimeout(() => {
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
        }, 950);
    }

    // Validate & proceed
    function tryProceed() {
        const val = overlayInput.value.trim();
        const num = parseFloat(val);

        if (!val || isNaN(num) || num <= 0) {
            qtyWarning.textContent = "Please enter a valid positive quantity";
            overlayInput.focus();
            return false;
        }

        qtyWarning.textContent = "";
        stdQtyInput.value = val;
        hideOverlayWithCurtain();

        // You can trigger additional sync/update functions here
        // updateQuantityTracker();
        // syncStdQtyToLots();

        return true;
    }

    overlayInput.addEventListener('input', tryProceed);
    overlayInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            tryProceed();
        }
    });

    // Allow user to reopen/edit later if needed (optional)
    stdQtyInput.addEventListener('focus', () => {
        if (overlay.classList.contains('hidden')) {
            // Optional: could re-show overlay in edit mode if you want
            // For now we just let them edit directly in menu bar
        }
    });

    // ── Lot management example (extend with your real table logic) ─────────
    function createLotHeader(lotNum) {
        const th = document.createElement('th');
        th.textContent = `Lot-${LOT_ROMAN[lotNum-1]}`;
        return th;
    }

    // ... rest of your application logic (ACB table, calculations, MathJax etc.)
</script>
</body>
</html>