<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light only">
    <title>NIR8 Chat Calculator</title>

    <!-- MathJax configuration -->
    <script>
        MathJax = {
            loader: { load: ['input/tex', 'output/chtml'] },
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                packages: {'[+]': ['base', 'ams']},
                processEscapes: true
            },
            chtml: { scale: 0.9, mtextInheritFont: true },
            startup: {
                typeset: false,
                pageReady() {
                    MathJax.startup.defaultPageReady();
                    document.dispatchEvent(new Event('MathJaxReady'));
                }
            }
        };
    </script>

    <!-- Load local Decimal.js with fallback -->
    <script src="decimal.min.js" onerror="loadDecimalFallback()"></script>
    <script>
        function loadDecimalFallback() {
            console.warn('Local Decimal.js failed to load. Attempting to load from CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js';
            script.async = true;
            script.onerror = () => {
                console.error('Failed to load Decimal.js from CDN. Some calculations may not work correctly.');
                alert('Unable to load Decimal.js. Please check your network connection or ensure the local file is available.');
            };
            script.onload = () => {
                console.log('Decimal.js loaded successfully from CDN.');
                initializeDecimal();
            };
            document.head.appendChild(script);
        }

        function initializeDecimal() {
            if (typeof Decimal !== 'undefined') {
                Decimal.set({ precision: 20, toExpNeg: -9, toExpPos: 20 });
            }
        }

        if (typeof Decimal !== 'undefined') {
            initializeDecimal();
        }
    </script>

    <!-- Load local MathJax with fallback -->
    <script src="assets/mathjax/es5/tex-mml-chtml.js" onerror="loadMathJaxFallback()" async></script>
    <script>
        function loadMathJaxFallback(attempt = 1, maxAttempts = 2) {
            console.warn(`Local MathJax failed to load. Attempting to load from CDN (Attempt ${attempt}/${maxAttempts})...`);
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            script.async = true;
            script.onerror = () => {
                if (attempt < maxAttempts) {
                    console.warn(`MathJax CDN attempt ${attempt} failed. Retrying...`);
                    loadMathJaxFallback(attempt + 1, maxAttempts);
                } else {
                    console.error('Failed to load MathJax from CDN after multiple attempts.');
                    alert('Unable to load MathJax. Equations will be displayed as plain text.');
                    document.getElementById('mathjax-loading').textContent = 'Failed to load equations.';
                    document.getElementById('mathjax-loading').style.display = 'block';
                    document.dispatchEvent(new Event('MathJaxReady'));
                }
            };
            script.onload = () => {
                console.log('MathJax loaded successfully from CDN.');
                document.getElementById('mathjax-loading').style.display = 'none';
                MathJax.startup.getComponents();
            };
            document.head.appendChild(script);
        }
    </script>

    <style>
        /* Chat Interface Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            height: calc(100vh - 100px);
            width: 95%;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-btn {
            background: white;
            border: 2px solid #4facfe;
            color: #4facfe;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .action-btn:hover {
            background: #4facfe;
            color: white;
            transform: translateX(5px);
        }

        .action-btn.active {
            background: #4facfe;
            color: white;
        }

        .status-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: 500;
            color: #4facfe;
            cursor: pointer;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            background: white;
            border: 1px solid #e9ecef;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.system {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }

        .calculation-result {
            background: #e8f4fd;
            border-left: 4px solid #4facfe;
            padding: 15px;
            margin-top: 10px;
            border-radius: 10px;
            font-family: monospace;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-area input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 50px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-area input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .input-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .input-buttons {
            display: flex;
            gap: 10px;
        }

        .suggestions {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            overflow-x: auto;
        }

        .suggestion-chip {
            background: #f1f8ff;
            border: 1px solid #d1e9ff;
            color: #4facfe;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #4facfe;
            color: white;
            transform: translateY(-2px);
        }

        .form-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .result-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            border-left: 4px solid #28a745;
        }

        .bot-avatar {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-size: 14px;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .message-header .bot-name {
            font-weight: 600;
            color: #4facfe;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 40px);
                margin: 10px;
                width: calc(100% - 20px);
            }

            .chat-main {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .messages-container {
                padding: 15px;
            }

            .message {
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                padding: 15px;
            }

            .input-area {
                padding: 15px;
            }

            .form-row {
                flex-direction: column;
            }
        }

        /* MathJax styles */
        .mjx-chtml {
            font-size: 110% !important;
        }

        /* Loading animation */
        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Scrollbar styling */
        .messages-container::-webkit-scrollbar {
            width: 8px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div id="mathjax-loading" style="display: none;">Loading equations...</div>
    
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü§ñ NIR8 Chat Calculator</h1>
            <p>Chat with AI to perform calculations, track quantities, and generate reports</p>
        </div>

        <div class="chat-main">
            <div class="sidebar">
                <div class="quick-actions">
                    <button class="action-btn active" onclick="sendMessage('help')">
                        üÜò Get Started
                    </button>
                    <button class="action-btn" onclick="sendMessage('calculate formula')">
                        üßÆ Formula Calculator
                    </button>
                    <button class="action-btn" onclick="sendMessage('acb calculator')">
                        üìä (A+C)-B Calculator
                    </button>
                    <button class="action-btn" onclick="sendMessage('track quantities')">
                        üìà Track Quantities
                    </button>
                    <button class="action-btn" onclick="sendMessage('print report')">
                        üñ®Ô∏è Print Report
                    </button>
                    <button class="action-btn" onclick="clearChat()">
                        üóëÔ∏è Clear Chat
                    </button>
                </div>

                <div class="status-panel">
                    <h3>üìä Current Status</h3>
                    <div class="status-item">
                        <span class="status-label">Calculations:</span>
                        <span id="calcCount" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Std Qty:</span>
                        <span id="statusStdQty" class="status-value">0.000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Dispensed:</span>
                        <span id="statusDispensed" class="status-value">0.000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Remaining:</span>
                        <span id="statusRemaining" class="status-value">0.000</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Mode:</span>
                        <span id="statusMode" class="status-value">Ready</span>
                    </div>
                </div>

                <div class="status-panel">
                    <h3>üí° Quick Examples</h3>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        Try: "Calculate F1 with Q=100, W=5, A=95"<br>
                        Or: "Show ACB calculator"<br>
                        Or: "Set std quantity to 1000"
                    </p>
                </div>
            </div>

            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <!-- Messages will be inserted here -->
                </div>

                <div class="suggestions" id="suggestions">
                    <!-- Suggestions will be inserted here -->
                </div>

                <div class="input-area">
                    <input type="text" id="userInput" placeholder="Type your message here... (Press Enter to send)" 
                           onkeypress="handleKeyPress(event)">
                    <button class="input-btn" onclick="sendUserMessage()">‚Üµ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configure Decimal.js
        Decimal.set({ precision: 20, toExpNeg: -9, toExpPos: 20 });

        // State variables
        let chatState = {
            mode: 'idle', // 'idle', 'awaiting_q', 'awaiting_w', 'awaiting_a', 'acb_mode'
            currentFormula: null,
            pendingCalculation: null,
            calculations: [],
            stdQty: 0,
            dispensedQty: 0,
            remainingQty: 0
        };

        // DOM Elements
        const dom = {
            messagesContainer: document.getElementById('messagesContainer'),
            userInput: document.getElementById('userInput'),
            suggestions: document.getElementById('suggestions'),
            statusElements: {
                calcCount: document.getElementById('calcCount'),
                stdQty: document.getElementById('statusStdQty'),
                dispensed: document.getElementById('statusDispensed'),
                remaining: document.getElementById('statusRemaining'),
                mode: document.getElementById('statusMode')
            }
        };

        // Initialize chat
        function initChat() {
            addMessage('system', 'Welcome to NIR8 Chat Calculator! I can help you with formula calculations, quantity tracking, and ACB calculations. How can I assist you today?');
            updateSuggestions(['Get started', 'Calculate formula', 'Track quantities', 'Show ACB calculator']);
            updateStatus();
        }

        // Add message to chat
        function addMessage(type, content, showTime = true) {
            const container = dom.messagesContainer;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let messageContent = '';
            if (type === 'bot') {
                messageContent = `
                    <div class="message-header">
                        <div class="bot-avatar">AI</div>
                        <div class="bot-name">NIR8 Assistant</div>
                    </div>
                    <div class="message-content">${content}</div>
                `;
            } else {
                messageContent = `
                    <div class="message-content">${content}</div>
                `;
            }
            
            if (showTime) {
                messageContent += `<div class="message-time">${time}</div>`;
            }
            
            messageDiv.innerHTML = messageContent;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const container = dom.messagesContainer;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.innerHTML = `
                <div class="message-header">
                    <div class="bot-avatar">AI</div>
                    <div class="bot-name">NIR8 Assistant</div>
                </div>
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;
            return typingDiv;
        }

        // Update suggestions
        function updateSuggestions(suggestions) {
            dom.suggestions.innerHTML = '';
            suggestions.forEach(text => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = text;
                chip.onclick = () => sendMessage(text);
                dom.suggestions.appendChild(chip);
            });
        }

        // Update status panel
        function updateStatus() {
            dom.statusElements.calcCount.textContent = chatState.calculations.length;
            dom.statusElements.stdQty.textContent = formatNumber(chatState.stdQty);
            dom.statusElements.dispensed.textContent = formatNumber(chatState.dispensedQty);
            dom.statusElements.remaining.textContent = formatNumber(chatState.remainingQty);
            dom.statusElements.mode.textContent = chatState.mode.charAt(0).toUpperCase() + chatState.mode.slice(1);
        }

        // Format number
        function formatNumber(num) {
            try {
                return new Decimal(num).toFixed(3);
            } catch {
                return '0.000';
            }
        }

        // Send user message
        function sendUserMessage() {
            const text = dom.userInput.value.trim();
            if (!text) return;
            
            addMessage('user', text);
            dom.userInput.value = '';
            
            // Simulate typing
            const typing = showTyping();
            
            // Process after delay
            setTimeout(() => {
                typing.remove();
                processMessage(text);
            }, 1000);
        }

        // Send message (for quick actions)
        function sendMessage(text) {
            dom.userInput.value = text;
            sendUserMessage();
        }

        // Process user message
        async function processMessage(text) {
            text = text.toLowerCase();
            
            if (text.includes('help') || text.includes('start')) {
                showHelp();
            } 
            else if (text.includes('calculate') || text.includes('formula')) {
                startFormulaCalculation(text);
            }
            else if (text.includes('acb') || text.includes('a+c') || text.includes('(a+c)-b')) {
                showACBCalculator();
            }
            else if (text.includes('track') || text.includes('quantity')) {
                trackQuantities(text);
            }
            else if (text.includes('print') || text.includes('report')) {
                printReport();
            }
            else if (text.includes('clear')) {
                clearChat();
            }
            else {
                handleRegularInput(text);
            }
        }

        // Show help
        function showHelp() {
            const helpText = `
                <h3>üìã Available Commands:</h3>
                <p><strong>Formula Calculations:</strong></p>
                <ul>
                    <li>"Calculate formula" - Start formula calculation</li>
                    <li>"Calculate F1 with Q=100, W=5, A=95" - Direct calculation</li>
                    <li>"F2 calculation" - Specific formula</li>
                </ul>
                <p><strong>Quantity Tracking:</strong></p>
                <ul>
                    <li>"Set std quantity 1000" - Set standard quantity</li>
                    <li>"Show quantities" - Display current quantities</li>
                    <li>"Update dispensed 500" - Update dispensed quantity</li>
                </ul>
                <p><strong>ACB Calculator:</strong></p>
                <ul>
                    <li>"Show ACB calculator" - Open ACB calculator</li>
                    <li>"Update Lot 1 issued 100" - Update issued quantity</li>
                </ul>
                <p><strong>Other:</strong></p>
                <ul>
                    <li>"Print report" - Generate printable report</li>
                    <li>"Clear chat" - Clear conversation</li>
                    <li>"Help" - Show this help</li>
                </ul>
            `;
            addMessage('bot', helpText);
            updateSuggestions(['Calculate F1', 'Set std quantity', 'Show ACB', 'Print report']);
        }

        // Start formula calculation
        function startFormulaCalculation(text) {
            // Try to extract parameters from message
            const params = extractParams(text);
            
            if (params.Q && params.W && params.A) {
                // Direct calculation
                const formula = text.includes('f1') ? 'F1' : text.includes('f2') ? 'F2' : text.includes('f3') ? 'F3' : 'F1';
                performCalculation(formula, params.Q, params.W, params.A);
            } else {
                // Start interactive mode
                chatState.mode = 'awaiting_q';
                chatState.currentFormula = text.includes('f1') ? 'F1' : 
                                          text.includes('f2') ? 'F2' : 
                                          text.includes('f3') ? 'F3' : null;
                
                let prompt = "Let's calculate a formula! ";
                if (chatState.currentFormula) {
                    prompt += `You selected ${chatState.currentFormula}. `;
                } else {
                    prompt += "Which formula would you like to use? (F1, F2, or F3) ";
                }
                prompt += "Please enter the Quantity (Q):";
                
                addMessage('bot', prompt);
                updateSuggestions(['100', '500', '1000', 'Cancel']);
            }
        }

        // Extract parameters from text
        function extractParams(text) {
            const params = {};
            const patterns = {
                Q: /q\s*[=:]\s*([\d.]+)/i,
                W: /w\s*[=:]\s*([\d.]+)/i,
                A: /a\s*[=:]\s*([\d.]+)/i
            };
            
            for (const [key, pattern] of Object.entries(patterns)) {
                const match = text.match(pattern);
                if (match) params[key] = parseFloat(match[1]);
            }
            
            return params;
        }

        // Handle regular input based on current mode
        function handleRegularInput(text) {
            const num = parseFloat(text);
            
            switch (chatState.mode) {
                case 'awaiting_q':
                    if (!isNaN(num)) {
                        chatState.pendingCalculation = { Q: num };
                        chatState.mode = 'awaiting_w';
                        addMessage('bot', `Great! Q = ${num}. Now enter Water Content (W):`);
                        updateSuggestions(['5', '10', '15', 'Cancel']);
                    } else if (text.includes('cancel')) {
                        chatState.mode = 'idle';
                        addMessage('bot', 'Calculation cancelled.');
                    } else {
                        addMessage('bot', 'Please enter a valid number for Quantity (Q):');
                    }
                    break;
                    
                case 'awaiting_w':
                    if (!isNaN(num)) {
                        chatState.pendingCalculation.W = num;
                        chatState.mode = 'awaiting_a';
                        addMessage('bot', `Got it! W = ${num}%. Now enter Assay Content (A):`);
                        updateSuggestions(['85', '90', '95', '98', 'Cancel']);
                    } else if (text.includes('cancel')) {
                        chatState.mode = 'idle';
                        addMessage('bot', 'Calculation cancelled.');
                    } else {
                        addMessage('bot', 'Please enter a valid number for Water Content (W):');
                    }
                    break;
                    
                case 'awaiting_a':
                    if (!isNaN(num)) {
                        chatState.pendingCalculation.A = num;
                        const formula = chatState.currentFormula || 'F1';
                        performCalculation(formula, 
                            chatState.pendingCalculation.Q, 
                            chatState.pendingCalculation.W, 
                            chatState.pendingCalculation.A);
                        chatState.mode = 'idle';
                    } else if (text.includes('cancel')) {
                        chatState.mode = 'idle';
                        addMessage('bot', 'Calculation cancelled.');
                    } else {
                        addMessage('bot', 'Please enter a valid number for Assay Content (A):');
                    }
                    break;
                    
                default:
                    // Try to interpret the message
                    if (!isNaN(num)) {
                        if (text.includes('std') || text.includes('standard')) {
                            chatState.stdQty = num;
                            addMessage('bot', `Standard quantity set to ${formatNumber(num)} kg`);
                            updateStatus();
                        } else if (text.includes('dispense')) {
                            chatState.dispensedQty = num;
                            addMessage('bot', `Dispensed quantity updated to ${formatNumber(num)} kg`);
                            updateStatus();
                        } else {
                            addMessage('bot', `I got the number ${num}. What would you like to do with it?`);
                        }
                    } else {
                        addMessage('bot', "I'm not sure what you mean. Try saying 'help' to see available commands, or use one of the quick actions.");
                    }
            }
        }

        // Perform calculation
        function performCalculation(formulaType, Q, W, A) {
            try {
                const hundred = new Decimal(100);
                const dQ = new Decimal(Q);
                const dW = new Decimal(W);
                const dA = new Decimal(A);
                
                let result, calculation;
                
                if (formulaType === 'F1' || formulaType === 'F3') {
                    const numerator = dQ.times(hundred).times(hundred);
                    const denominator = dA.times(hundred.minus(dW));
                    result = numerator.div(denominator);
                    
                    calculation = {
                        type: formulaType,
                        Q: Q,
                        W: W,
                        A: A,
                        result: result.toNumber(),
                        timestamp: new Date()
                    };
                    
                    const resultText = `
                        <div class="calculation-result">
                            <h4>${formulaType} Calculation Result:</h4>
                            <p>Formula: F = (Q √ó 100 √ó 100) / (A √ó (100 - W))</p>
                            <p>Q = ${Q}, W = ${W}%, A = ${A}%</p>
                            <p>Calculation: (${Q} √ó 100 √ó 100) / (${A} √ó (100 - ${W}))</p>
                            <p><strong>Result: ${result.toFixed(3)}</strong></p>
                        </div>
                    `;
                    
                    addMessage('bot', `‚úÖ ${formulaType} calculation complete!${resultText}`);
                    
                } else if (formulaType === 'F2') {
                    const numerator = dQ.times(dA).times(hundred.minus(dW));
                    const denominator = hundred.times(hundred);
                    result = numerator.div(denominator);
                    
                    calculation = {
                        type: formulaType,
                        Q: Q,
                        W: W,
                        A: A,
                        result: result.toNumber(),
                        timestamp: new Date()
                    };
                    
                    const resultText = `
                        <div class="calculation-result">
                            <h4>${formulaType} Calculation Result:</h4>
                            <p>Formula: F = (Q √ó A √ó (100 - W)) / (100 √ó 100)</p>
                            <p>Q = ${Q}, W = ${W}%, A = ${A}%</p>
                            <p>Calculation: (${Q} √ó ${A} √ó (100 - ${W})) / (100 √ó 100)</p>
                            <p><strong>Result: ${result.toFixed(3)}</strong></p>
                        </div>
                    `;
                    
                    addMessage('bot', `‚úÖ ${formulaType} calculation complete!${resultText}`);
                }
                
                // Store calculation
                chatState.calculations.push(calculation);
                
                // Update dispensed quantity
                if (formulaType === 'F2') {
                    chatState.dispensedQty = new Decimal(chatState.dispensedQty).plus(Q).toNumber();
                } else {
                    chatState.dispensedQty = new Decimal(chatState.dispensedQty).plus(result).toNumber();
                }
                
                // Update remaining
                chatState.remainingQty = new Decimal(chatState.stdQty).minus(chatState.dispensedQty).toNumber();
                
                updateStatus();
                updateSuggestions(['Calculate another', 'Show ACB', 'Print report', 'Clear']);
                
            } catch (error) {
                addMessage('bot', `‚ùå Calculation failed: ${error.message}`);
            }
        }

        // Show ACB calculator
        function showACBCalculator() {
            const acbHtml = `
                <div class="calculation-result">
                    <h4>üìä (A+C)-B Calculator</h4>
                    <p>This calculator helps track standard vs issued quantities across lots.</p>
                    <p><strong>Available Commands:</strong></p>
                    <ul>
                        <li>"Set Lot 1 A 417" - Set standard quantity A for Lot 1</li>
                        <li>"Set Lot 2 C 84.375" - Set standard quantity C for Lot 2</li>
                        <li>"Issue Lot 1 100" - Update issued quantity for Lot 1</li>
                        <li>"Show ACB totals" - Display current totals</li>
                        <li>"Reset ACB" - Reset all values</li>
                    </ul>
                    <p>Try: "Issue Lot 1 150" or "Set Lot 3 A 450"</p>
                </div>
            `;
            addMessage('bot', acbHtml);
            chatState.mode = 'acb_mode';
            updateSuggestions(['Issue Lot 1', 'Show totals', 'Reset ACB', 'Back to main']);
        }

        // Track quantities
        function trackQuantities(text) {
            const num = parseFloat(text.match(/\d+/)?.[0]);
            
            if (text.includes('std') || text.includes('standard')) {
                if (!isNaN(num)) {
                    chatState.stdQty = num;
                    addMessage('bot', `‚úÖ Standard quantity set to ${formatNumber(num)} kg`);
                    updateStatus();
                } else {
                    const qtyHtml = `
                        <div class="form-inputs">
                            <h4>üìà Quantity Tracking</h4>
                            <p>Current status:</p>
                            <div class="result-display">
                                <p>Standard Qty: ${formatNumber(chatState.stdQty)} kg</p>
                                <p>Dispensed: ${formatNumber(chatState.dispensedQty)} kg</p>
                                <p>Remaining: ${formatNumber(chatState.remainingQty)} kg</p>
                            </div>
                            <p>To update, say: "Set std quantity [number]"</p>
                        </div>
                    `;
                    addMessage('bot', qtyHtml);
                }
            }
        }

        // Print report
        function printReport() {
            if (chatState.calculations.length === 0) {
                addMessage('bot', 'No calculations to report. Perform some calculations first.');
                return;
            }
            
            let report = `<div class="calculation-result">
                <h4>üìÑ Calculation Report</h4>
                <p>Total Calculations: ${chatState.calculations.length}</p>
                <p>Generated: ${new Date().toLocaleString()}</p>
                <hr>`;
            
            chatState.calculations.forEach((calc, index) => {
                report += `
                    <p><strong>Calculation ${index + 1}:</strong></p>
                    <p>Type: ${calc.type}</p>
                    <p>Q: ${calc.Q}, W: ${calc.W}%, A: ${calc.A}%</p>
                    <p>Result: ${formatNumber(calc.result)}</p>
                    <hr>
                `;
            });
            
            report += `<p><strong>Summary:</strong></p>
                <p>Standard Quantity: ${formatNumber(chatState.stdQty)} kg</p>
                <p>Total Dispensed: ${formatNumber(chatState.dispensedQty)} kg</p>
                <p>Remaining: ${formatNumber(chatState.remainingQty)} kg</p>
            </div>`;
            
            addMessage('bot', report);
            updateSuggestions(['Print now', 'Export', 'New calculation', 'Clear']);
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear all chat messages?')) {
                dom.messagesContainer.innerHTML = '';
                addMessage('system', 'Chat cleared. How can I help you?');
                updateSuggestions(['Get started', 'Calculate formula', 'Track quantities', 'Show ACB calculator']);
            }
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendUserMessage();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initChat);
    </script>
</body>
</html>